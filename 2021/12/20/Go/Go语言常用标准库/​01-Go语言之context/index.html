<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Go语言之context | John Doe</title><meta name="keywords" content="Go语言常用标准库"><meta name="author" content="John Doe"><meta name="copyright" content="John Doe"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="在 Go http包的Server中，每一个请求在都有一个对应的 goroutine 去处理。请求处理函数通常会启动额外的 goroutine 用来访问后端服务，比如数据库和RPC服务。用来处理一个请求的 goroutine 通常需要访问一些与请求特定的数据，比如终端用户的身份认证信息、验证相关的token、请求的截止时间。 当一个请求被取消或超时时，所有用来处理该请求的 goroutine 都应">
<meta property="og:type" content="article">
<meta property="og:title" content="Go语言之context">
<meta property="og:url" content="http://www.zhangxiaotao.live/2021/12/20/Go/Go%E8%AF%AD%E8%A8%80%E5%B8%B8%E7%94%A8%E6%A0%87%E5%87%86%E5%BA%93/%E2%80%8B01-Go%E8%AF%AD%E8%A8%80%E4%B9%8Bcontext/index.html">
<meta property="og:site_name" content="John Doe">
<meta property="og:description" content="在 Go http包的Server中，每一个请求在都有一个对应的 goroutine 去处理。请求处理函数通常会启动额外的 goroutine 用来访问后端服务，比如数据库和RPC服务。用来处理一个请求的 goroutine 通常需要访问一些与请求特定的数据，比如终端用户的身份认证信息、验证相关的token、请求的截止时间。 当一个请求被取消或超时时，所有用来处理该请求的 goroutine 都应">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://picture-typora-bucket.oss-cn-shanghai.aliyuncs.com/typora/go.png">
<meta property="article:published_time" content="2021-12-20T11:35:00.000Z">
<meta property="article:modified_time" content="2021-12-20T11:24:43.905Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="Go语言常用标准库">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://picture-typora-bucket.oss-cn-shanghai.aliyuncs.com/typora/go.png"><link rel="shortcut icon" href="/img/avatar.png"><link rel="canonical" href="http://www.zhangxiaotao.live/2021/12/20/Go/Go%E8%AF%AD%E8%A8%80%E5%B8%B8%E7%94%A8%E6%A0%87%E5%87%86%E5%BA%93/%E2%80%8B01-Go%E8%AF%AD%E8%A8%80%E4%B9%8Bcontext/"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.5/dist/instantsearch.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.5/dist/instantsearch.min.js" defer=""></script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"B0YYEXE704","apiKey":"df3b5032cce15f8c2fe870edf0ff7d98","indexName":"blog","hits":{"per_page":10},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":1,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":500},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Go语言之context',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-12-20 19:24:43'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/mouse.css"><style>#article-container.post-content h1:before, h2:before, h3:before, h4:before, h5:before, h6:before { -webkit-animation: avatar_turn_around 1s linear infinite; -moz-animation: avatar_turn_around 1s linear infinite; -o-animation: avatar_turn_around 1s linear infinite; -ms-animation: avatar_turn_around 1s linear infinite; animation: avatar_turn_around 1s linear infinite; }</style><link rel="stylesheet" href="/css/copyright.css"><link rel="stylesheet" href="/css/modify.styl"><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/HCLonely/images@master/others/heartbeat.min.css"><meta name="generator" content="Hexo 5.4.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="wizard-scene"><div class="wizard-objects"><div class="wizard-square"></div><div class="wizard-circle"></div><div class="wizard-triangle"></div></div><div class="wizard"><div class="wizard-body"></div><div class="wizard-right-arm"><div class="wizard-right-hand"></div></div><div class="wizard-left-arm"><div class="wizard-left-hand"></div></div><div class="wizard-head"><div class="wizard-beard"></div><div class="wizard-face"><div class="wizard-adds"></div></div><div class="wizard-hat"><div class="wizard-hat-of-the-hat"></div><div class="wizard-four-point-star --first"></div><div class="wizard-four-point-star --second"></div><div class="wizard-four-point-star --third"></div></div></div></div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://picture-typora-bucket.oss-cn-shanghai.aliyuncs.com/typora/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">380</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">38</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">44</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/love/"><i class="fa-fw fas fa-gift"></i><span> Love</span></a></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background: transparent"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">John Doe</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/love/"><i class="fa-fw fas fa-gift"></i><span> Love</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Go语言之context</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-12-20T11:35:00.000Z" title="发表于 2021-12-20 19:35:00">2021-12-20</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-12-20T11:24:43.905Z" title="更新于 2021-12-20 19:24:43">2021-12-20</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Go/">Go</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Go/Go%E8%AF%AD%E8%A8%80%E5%B8%B8%E7%94%A8%E6%A0%87%E5%87%86%E5%BA%93/">Go语言常用标准库</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Go语言之context"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>在 Go http包的Server中，每一个请求在都有一个对应的 goroutine 去处理。请求处理函数通常会启动额外的 goroutine 用来访问后端服务，比如数据库和RPC服务。用来处理一个请求的 goroutine 通常需要访问一些与请求特定的数据，比如终端用户的身份认证信息、验证相关的token、请求的截止时间。 当一个请求被取消或超时时，所有用来处理该请求的 goroutine 都应该迅速退出，然后系统才能释放这些 goroutine 占用的资源。</p>
<h1 id="为什么需要Context"><a href="#为什么需要Context" class="headerlink" title="为什么需要Context"></a>为什么需要Context</h1><h1 id="基本示例"><a href="#基本示例" class="headerlink" title="基本示例"></a>基本示例</h1><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	&amp;quot;fmt&amp;quot;</span><br><span class="line">	&amp;quot;sync&amp;quot;</span><br><span class="line"></span><br><span class="line">	&amp;quot;time&amp;quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">var wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line">// 初始的例子</span><br><span class="line"></span><br><span class="line">func worker() {</span><br><span class="line">	for {</span><br><span class="line">		fmt.Println(&amp;quot;worker&amp;quot;)</span><br><span class="line">		time.Sleep(time.Second)</span><br><span class="line">	}</span><br><span class="line">	// 如何接收外部命令实现退出</span><br><span class="line">	wg.Done()</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">func main() {</span><br><span class="line">	wg.Add(1)</span><br><span class="line">	go worker()</span><br><span class="line">	// 如何优雅的实现结束子goroutine</span><br><span class="line">	wg.Wait()</span><br><span class="line">	fmt.Println(&amp;quot;over&amp;quot;)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h1 id="全局变量方式"><a href="#全局变量方式" class="headerlink" title="全局变量方式"></a>全局变量方式</h1><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	&amp;quot;fmt&amp;quot;</span><br><span class="line">	&amp;quot;sync&amp;quot;</span><br><span class="line"></span><br><span class="line">	&amp;quot;time&amp;quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">var wg sync.WaitGroup</span><br><span class="line">var exit bool</span><br><span class="line"></span><br><span class="line">// 全局变量方式存在的问题：</span><br><span class="line">// 1. 使用全局变量在跨包调用时不容易统一</span><br><span class="line">// 2. 如果worker中再启动goroutine，就不太好控制了。</span><br><span class="line"></span><br><span class="line">func worker() {</span><br><span class="line">	for {</span><br><span class="line">		fmt.Println(&amp;quot;worker&amp;quot;)</span><br><span class="line">		time.Sleep(time.Second)</span><br><span class="line">		if exit {</span><br><span class="line">			break</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">	wg.Done()</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">func main() {</span><br><span class="line">	wg.Add(1)</span><br><span class="line">	go worker()</span><br><span class="line">	time.Sleep(time.Second * 3) // sleep3秒以免程序过快退出</span><br><span class="line">	exit = true                 // 修改全局变量实现子goroutine的退出</span><br><span class="line">	wg.Wait()</span><br><span class="line">	fmt.Println(&amp;quot;over&amp;quot;)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h1 id="通道方式"><a href="#通道方式" class="headerlink" title="通道方式"></a>通道方式</h1><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	&amp;quot;fmt&amp;quot;</span><br><span class="line">	&amp;quot;sync&amp;quot;</span><br><span class="line"></span><br><span class="line">	&amp;quot;time&amp;quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">var wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line">// 管道方式存在的问题：</span><br><span class="line">// 1. 使用全局变量在跨包调用时不容易实现规范和统一，需要维护一个共用的channel</span><br><span class="line"></span><br><span class="line">func worker(exitChan chan struct{}) {</span><br><span class="line">LOOP:</span><br><span class="line">	for {</span><br><span class="line">		fmt.Println(&amp;quot;worker&amp;quot;)</span><br><span class="line">		time.Sleep(time.Second)</span><br><span class="line">		select {</span><br><span class="line">		case &amp;lt;-exitChan: // 等待接收上级通知</span><br><span class="line">			break LOOP</span><br><span class="line">		default:</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">	wg.Done()</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">func main() {</span><br><span class="line">	var exitChan = make(chan struct{})</span><br><span class="line">	wg.Add(1)</span><br><span class="line">	go worker(exitChan)</span><br><span class="line">	time.Sleep(time.Second * 3) // sleep3秒以免程序过快退出</span><br><span class="line">	exitChan &amp;lt;- struct{}{}      // 给子goroutine发送退出信号</span><br><span class="line">	close(exitChan)</span><br><span class="line">	wg.Wait()</span><br><span class="line">	fmt.Println(&amp;quot;over&amp;quot;)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h1 id="官方版的方案"><a href="#官方版的方案" class="headerlink" title="官方版的方案"></a>官方版的方案</h1><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	&amp;quot;context&amp;quot;</span><br><span class="line">	&amp;quot;fmt&amp;quot;</span><br><span class="line">	&amp;quot;sync&amp;quot;</span><br><span class="line"></span><br><span class="line">	&amp;quot;time&amp;quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">var wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line">func worker(ctx context.Context) {</span><br><span class="line">LOOP:</span><br><span class="line">	for {</span><br><span class="line">		fmt.Println(&amp;quot;worker&amp;quot;)</span><br><span class="line">		time.Sleep(time.Second)</span><br><span class="line">		select {</span><br><span class="line">		case &amp;lt;-ctx.Done(): // 等待上级通知</span><br><span class="line">			break LOOP</span><br><span class="line">		default:</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">	wg.Done()</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">func main() {</span><br><span class="line">	ctx, cancel := context.WithCancel(context.Background())</span><br><span class="line">	wg.Add(1)</span><br><span class="line">	go worker(ctx)</span><br><span class="line">	time.Sleep(time.Second * 3)</span><br><span class="line">	cancel() // 通知子goroutine结束</span><br><span class="line">	wg.Wait()</span><br><span class="line">	fmt.Println(&amp;quot;over&amp;quot;)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>当子goroutine又开启另外一个goroutine时，只需要将ctx传入即可：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	&amp;quot;context&amp;quot;</span><br><span class="line">	&amp;quot;fmt&amp;quot;</span><br><span class="line">	&amp;quot;sync&amp;quot;</span><br><span class="line"></span><br><span class="line">	&amp;quot;time&amp;quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">var wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line">func worker(ctx context.Context) {</span><br><span class="line">	go worker2(ctx)</span><br><span class="line">LOOP:</span><br><span class="line">	for {</span><br><span class="line">		fmt.Println(&amp;quot;worker&amp;quot;)</span><br><span class="line">		time.Sleep(time.Second)</span><br><span class="line">		select {</span><br><span class="line">		case &amp;lt;-ctx.Done(): // 等待上级通知</span><br><span class="line">			break LOOP</span><br><span class="line">		default:</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">	wg.Done()</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">func worker2(ctx context.Context) {</span><br><span class="line">LOOP:</span><br><span class="line">	for {</span><br><span class="line">		fmt.Println(&amp;quot;worker2&amp;quot;)</span><br><span class="line">		time.Sleep(time.Second)</span><br><span class="line">		select {</span><br><span class="line">		case &amp;lt;-ctx.Done(): // 等待上级通知</span><br><span class="line">			break LOOP</span><br><span class="line">		default:</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">}</span><br><span class="line">func main() {</span><br><span class="line">	ctx, cancel := context.WithCancel(context.Background())</span><br><span class="line">	wg.Add(1)</span><br><span class="line">	go worker(ctx)</span><br><span class="line">	time.Sleep(time.Second * 3)</span><br><span class="line">	cancel() // 通知子goroutine结束</span><br><span class="line">	wg.Wait()</span><br><span class="line">	fmt.Println(&amp;quot;over&amp;quot;)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h1 id="Context初识"><a href="#Context初识" class="headerlink" title="Context初识"></a>Context初识</h1><p>Go1.7加入了一个新的标准库<code>context</code>，它定义了<code>Context</code>类型，专门用来简化 对于处理单个请求的多个 goroutine 之间与请求域的数据、取消信号、截止时间等相关操作，这些操作可能涉及多个 API 调用。</p>
<p>对服务器传入的请求应该创建上下文，而对服务器的传出调用应该接受上下文。它们之间的函数调用链必须传递上下文，或者可以使用<code>WithCancel</code>、<code>WithDeadline</code>、<code>WithTimeout</code>或<code>WithValue</code>创建的派生上下文。当一个上下文被取消时，它派生的所有上下文也被取消。</p>
<h1 id="Context接口"><a href="#Context接口" class="headerlink" title="Context接口"></a>Context接口</h1><p><code>context.Context</code>是一个接口，该接口定义了四个需要实现的方法。具体签名如下：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">type Context interface {</span><br><span class="line">    Deadline() (deadline time.Time, ok bool)</span><br><span class="line">    Done() &amp;lt;-chan struct{}</span><br><span class="line">    Err() error</span><br><span class="line">    Value(key interface{}) interface{}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>其中：</p>
<ul>
<li><p><code>Deadline</code>方法需要返回当前<code>Context</code>被取消的时间，也就是完成工作的截止时间（deadline）；</p>
</li>
<li><p><code>Done</code>方法需要返回一个<code>Channel</code>，这个Channel会在当前工作完成或者上下文被取消之后关闭，多次调用<code>Done</code>方法会返回同一个Channel；</p>
</li>
<li><p>```<br>Err</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">方法会返回当前</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p>Context</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">结束的原因，它只会在</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p>Done</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  返回的Channel被关闭时才会返回非空的值；</span><br><span class="line"></span><br><span class="line">  - 如果当前`Context`被取消就会返回`Canceled`错误；</span><br><span class="line">  - 如果当前`Context`超时就会返回`DeadlineExceeded`错误；</span><br><span class="line"></span><br><span class="line">- `Value`方法会从`Context`中返回键对应的值，对于同一个上下文来说，多次调用`Value` 并传入相同的`Key`会返回相同的结果，该方法仅用于传递跨API和进程间跟请求域的数据；</span><br><span class="line"></span><br><span class="line"># Background()和TODO()</span><br><span class="line"></span><br><span class="line">Go内置两个函数：`Background()`和`TODO()`，这两个函数分别返回一个实现了`Context`接口的`background`和`todo`。我们代码中最开始都是以这两个内置的上下文对象作为最顶层的`partent context`，衍生出更多的子上下文对象。</span><br><span class="line"></span><br><span class="line">`Background()`主要用于main函数、初始化以及测试代码中，作为Context这个树结构的最顶层的Context，也就是根Context。</span><br><span class="line"></span><br><span class="line">`TODO()`，它目前还不知道具体的使用场景，如果我们不知道该使用什么Context的时候，可以使用这个。</span><br><span class="line"></span><br><span class="line">`background`和`todo`本质上都是`emptyCtx`结构体类型，是一个不可取消，没有设置截止时间，没有携带任何值的Context。</span><br><span class="line"></span><br><span class="line"># With系列函数</span><br><span class="line"></span><br><span class="line">此外，`context`包中还定义了四个With系列函数。</span><br><span class="line"></span><br><span class="line"># WithCancel</span><br><span class="line"></span><br><span class="line">`WithCancel`的函数签名如下：</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p>func WithCancel(parent Context) (ctx Context, cancel CancelFunc)</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">`WithCancel`返回带有新Done通道的父节点的副本。当调用返回的cancel函数或当关闭父上下文的Done通道时，将关闭返回上下文的Done通道，无论先发生什么情况。</span><br><span class="line"></span><br><span class="line">取消此上下文将释放与其关联的资源，因此代码应该在此上下文中运行的操作完成后立即调用cancel。</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p>func gen(ctx context.Context) &lt;-chan int {</p>
<pre><code>  dst := make(chan int)
  n := 1
  go func() {
      for {
          select {
          case &amp;lt;-ctx.Done():
              return // return结束该goroutine，防止泄露
          case dst &amp;lt;- n:
              n++
          }
      }
  }()
  return dst
</code></pre>
<p>  }<br>func main() {<br>  ctx, cancel := context.WithCancel(context.Background())<br>  defer cancel() // 当我们取完需要的整数后调用cancel</p>
<p>  for n := range gen(ctx) {</p>
<pre><code>  fmt.Println(n)
  if n == 5 {
      break
  }
</code></pre>
<p>  }<br>}</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">上面的示例代码中，`gen`函数在单独的goroutine中生成整数并将它们发送到返回的通道。 gen的调用者在使用生成的整数之后需要取消上下文，以免`gen`启动的内部goroutine发生泄漏。</span><br><span class="line"></span><br><span class="line"># WithDeadline</span><br><span class="line"></span><br><span class="line">`WithDeadline`的函数签名如下：</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p>func WithDeadline(parent Context, deadline time.Time) (Context, CancelFunc)</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">返回父上下文的副本，并将deadline调整为不迟于d。如果父上下文的deadline已经早于d，则WithDeadline(parent, d)在语义上等同于父上下文。当截止日过期时，当调用返回的cancel函数时，或者当父上下文的Done通道关闭时，返回上下文的Done通道将被关闭，以最先发生的情况为准。</span><br><span class="line"></span><br><span class="line">取消此上下文将释放与其关联的资源，因此代码应该在此上下文中运行的操作完成后立即调用cancel。</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p>func main() {<br>  d := time.Now().Add(50 * time.Millisecond)<br>  ctx, cancel := context.WithDeadline(context.Background(), d)</p>
<p>  // 尽管ctx会过期，但在任何情况下调用它的cancel函数都是很好的实践。<br>  // 如果不这样做，可能会使上下文及其父类存活的时间超过必要的时间。<br>  defer cancel()</p>
<p>  select {<br>  case &lt;-time.After(1 * time.Second):</p>
<pre><code>  fmt.Println(&amp;quot;overslept&amp;quot;)
</code></pre>
<p>  case &lt;-ctx.Done():</p>
<pre><code>  fmt.Println(ctx.Err())
</code></pre>
<p>  }<br>}</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">上面的代码中，定义了一个50毫秒之后过期的deadline，然后我们调用`context.WithDeadline(context.Background(), d)`得到一个上下文（ctx）和一个取消函数（cancel），然后使用一个select让主程序陷入等待：等待1秒后打印`overslept`退出或者等待ctx过期后退出。 因为ctx50秒后就过期，所以`ctx.Done()`会先接收到值，上面的代码会打印ctx.Err()取消原因。</span><br><span class="line"></span><br><span class="line"># WithTimeout</span><br><span class="line"></span><br><span class="line">`WithTimeout`的函数签名如下：</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p>func WithTimeout(parent Context, timeout time.Duration) (Context, CancelFunc)</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">`WithTimeout`返回`WithDeadline(parent, time.Now().Add(timeout))`。</span><br><span class="line"></span><br><span class="line">取消此上下文将释放与其相关的资源，因此代码应该在此上下文中运行的操作完成后立即调用cancel，通常用于数据库或者网络连接的超时控制。具体示例如下：</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p>package main</p>
</li>
</ul>
<p>import (<br>    "context"<br>    "fmt"<br>    "sync"</p>
<pre><code>&amp;quot;time&amp;quot;
</code></pre>
<p>)</p>
<p>// context.WithTimeout</p>
<p>var wg sync.WaitGroup</p>
<p>func worker(ctx context.Context) {<br>LOOP:<br>    for {<br>        fmt.Println("db connecting …")<br>        time.Sleep(time.Millisecond * 10) // 假设正常连接数据库耗时10毫秒<br>        select {<br>        case &lt;-ctx.Done(): // 50毫秒后自动调用<br>            break LOOP<br>        default:<br>        }<br>    }<br>    fmt.Println("worker done!")<br>    wg.Done()<br>}</p>
<p>func main() {<br>    // 设置一个50毫秒的超时<br>    ctx, cancel := context.WithTimeout(context.Background(), time.Millisecond*50)<br>    wg.Add(1)<br>    go worker(ctx)<br>    time.Sleep(time.Second * 5)<br>    cancel() // 通知子goroutine结束<br>    wg.Wait()<br>    fmt.Println("over")<br>}</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># WithValue</span><br><span class="line"></span><br><span class="line">`WithValue`函数能够将请求作用域的数据与 Context 对象建立关系。声明如下：</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p>func WithValue(parent Context, key, val interface{}) Context</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">`WithValue`返回父节点的副本，其中与key关联的值为val。</span><br><span class="line"></span><br><span class="line">仅对API和进程间传递请求域的数据使用上下文值，而不是使用它来传递可选参数给函数。</span><br><span class="line"></span><br><span class="line">所提供的键必须是可比较的，并且不应该是`string`类型或任何其他内置类型，以避免使用上下文在包之间发生冲突。`WithValue`的用户应该为键定义自己的类型。为了避免在分配给interface{}时进行分配，上下文键通常具有具体类型`struct{}`。或者，导出的上下文关键变量的静态类型应该是指针或接口。</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p>package main</p>
<p>import (<br>    "context"<br>    "fmt"<br>    "sync"</p>
<pre><code>&amp;quot;time&amp;quot;
</code></pre>
<p>)</p>
<p>// context.WithValue</p>
<p>type TraceCode string</p>
<p>var wg sync.WaitGroup</p>
<p>func worker(ctx context.Context) {<br>    key := TraceCode("TRACE_CODE")<br>    traceCode, ok := ctx.Value(key).(string) // 在子goroutine中获取trace code<br>    if !ok {<br>        fmt.Println("invalid trace code")<br>    }<br>LOOP:<br>    for {<br>        fmt.Printf("worker, trace code:%s\n", traceCode)<br>        time.Sleep(time.Millisecond * 10) // 假设正常连接数据库耗时10毫秒<br>        select {<br>        case &lt;-ctx.Done(): // 50毫秒后自动调用<br>            break LOOP<br>        default:<br>        }<br>    }<br>    fmt.Println("worker done!")<br>    wg.Done()<br>}</p>
<p>func main() {<br>    // 设置一个50毫秒的超时<br>    ctx, cancel := context.WithTimeout(context.Background(), time.Millisecond*50)<br>    // 在系统的入口中设置trace code传递给后续启动的goroutine实现日志数据聚合<br>    ctx = context.WithValue(ctx, TraceCode("TRACE_CODE"), "12512312234")<br>    wg.Add(1)<br>    go worker(ctx)<br>    time.Sleep(time.Second * 5)<br>    cancel() // 通知子goroutine结束<br>    wg.Wait()<br>    fmt.Println("over")<br>}</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># 使用Context的注意事项</span><br><span class="line"></span><br><span class="line">- 推荐以参数的方式显示传递Context</span><br><span class="line">- 以Context作为参数的函数方法，应该把Context作为第一个参数。</span><br><span class="line">- 给一个函数方法传递Context的时候，不要传递nil，如果不知道传递什么，就使用context.TODO()</span><br><span class="line">- Context的Value相关方法应该传递请求域的必要数据，不应该用于传递可选参数</span><br><span class="line">- Context是线程安全的，可以放心的在多个goroutine中传递</span><br><span class="line"></span><br><span class="line"># 客户端超时取消示例</span><br><span class="line"></span><br><span class="line">调用服务端API时如何在客户端实现超时控制？</span><br><span class="line"></span><br><span class="line"># server端</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p>// context_timeout/server/main.go<br>package main</p>
<p>import (<br>    "fmt"<br>    "math/rand"<br>    "net/http"</p>
<pre><code>&amp;quot;time&amp;quot;
</code></pre>
<p>)</p>
<p>// server端，随机出现慢响应</p>
<p>func indexHandler(w http.ResponseWriter, r *http.Request) {<br>    number := rand.Intn(2)<br>    if number == 0 {<br>        time.Sleep(time.Second * 10) // 耗时10秒的慢响应<br>        fmt.Fprintf(w, "slow response")<br>        return<br>    }<br>    fmt.Fprint(w, "quick response")<br>}</p>
<p>func main() {<br>    http.HandleFunc("/", indexHandler)<br>    err := http.ListenAndServe(":8000", nil)<br>    if err != nil {<br>        panic(err)<br>    }<br>}</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># client端</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p>// context_timeout/client/main.go<br>package main</p>
<p>import (<br>    "context"<br>    "fmt"<br>    "io/ioutil"<br>    "net/http"<br>    "sync"<br>    "time"<br>)</p>
<p>// 客户端</p>
<p>type respData struct {<br>    resp *http.Response<br>    err  error<br>}</p>
<p>func doCall(ctx context.Context) {<br>    transport := http.Transport{<br>       // 请求频繁可定义全局的client对象并启用长链接<br>       // 请求不频繁使用短链接<br>       DisableKeepAlives: true,     }<br>    client := http.Client{<br>        Transport: &amp;transport,<br>    }</p>
<pre><code>respChan := make(chan *respData, 1)
req, err := http.NewRequest(&amp;quot;GET&amp;quot;, &amp;quot;http://127.0.0.1:8000/&amp;quot;, nil)
if err != nil {
    fmt.Printf(&amp;quot;new requestg failed, err:%v\n&amp;quot;, err)
    return
}
req = req.WithContext(ctx) // 使用带超时的ctx创建一个新的client request
var wg sync.WaitGroup
wg.Add(1)
defer wg.Wait()
go func() {
    resp, err := client.Do(req)
    fmt.Printf(&amp;quot;client.do resp:%v, err:%v\n&amp;quot;, resp, err)
    rd := &amp;amp;respData{
        resp: resp,
        err:  err,
    }
    respChan &amp;lt;- rd
    wg.Done()
}()

select {
case &amp;lt;-ctx.Done():
    //transport.CancelRequest(req)
    fmt.Println(&amp;quot;call api timeout&amp;quot;)
case result := &amp;lt;-respChan:
    fmt.Println(&amp;quot;call server api success&amp;quot;)
    if result.err != nil {
        fmt.Printf(&amp;quot;call server api failed, err:%v\n&amp;quot;, result.err)
        return
    }
    defer result.resp.Body.Close()
    data, _ := ioutil.ReadAll(result.resp.Body)
    fmt.Printf(&amp;quot;resp:%v\n&amp;quot;, string(data))
}
</code></pre>
<p>}</p>
<p>func main() {<br>    // 定义一个100毫秒的超时<br>    ctx, cancel := context.WithTimeout(context.Background(), time.Millisecond*100)<br>    defer cancel() // 调用cancel释放子goroutine资源<br>    doCall(ctx)<br>}</p>
<pre><code>
</code></pre>
</article><div class="post-copyright"><div class="post-copyright__title"><span class="post-copyright-info"><h>Go语言之context</h></span></div><div class="post-copyright__type"><span class="post-copyright-info"><a href="http://www.zhangxiaotao.live/2021/12/20/Go/Go%E8%AF%AD%E8%A8%80%E5%B8%B8%E7%94%A8%E6%A0%87%E5%87%86%E5%BA%93/%E2%80%8B01-Go%E8%AF%AD%E8%A8%80%E4%B9%8Bcontext/">http://www.zhangxiaotao.live/2021/12/20/Go/Go%E8%AF%AD%E8%A8%80%E5%B8%B8%E7%94%A8%E6%A0%87%E5%87%86%E5%BA%93/%E2%80%8B01-Go%E8%AF%AD%E8%A8%80%E4%B9%8Bcontext/</a></span></div><div class="post-copyright-m"><div class="post-copyright-m-info"><div class="post-copyright-a" style="display: inline-block;width: 120px"><h>作者</h><div class="post-copyright-cc-info"><h>John Doe</h></div></div><div class="post-copyright-c" style="display: inline-block;width: 120px"><h>发布于</h><div class="post-copyright-cc-info"><h>2021-12-20</h></div></div><div class="post-copyright-u" style="display: inline-block;width: 120px"><h>更新于</h><div class="post-copyright-cc-info"><h>2021-12-20</h></div></div><div class="post-copyright-c" style="display: inline-block;width: 120px"><h>许可协议</h><div class="post-copyright-cc-info"><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel="noopener" target="_blank" title="CC BY 4.0" href="https://creativecommons.org/licenses/by/4.0/deed.zh">CC BY 4.0</a></div></div></div></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Go%E8%AF%AD%E8%A8%80%E5%B8%B8%E7%94%A8%E6%A0%87%E5%87%86%E5%BA%93/">Go语言常用标准库</a></div><div class="post_share"><div class="social-share" data-image="https://picture-typora-bucket.oss-cn-shanghai.aliyuncs.com/typora/go.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer=""></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/12/20/Go/Go%E8%AF%AD%E8%A8%80%E5%B8%B8%E7%94%A8%E6%A0%87%E5%87%86%E5%BA%93/06-Go%E8%AF%AD%E8%A8%80%E4%B9%8Bstrconv/"><img class="prev-cover" src="https://picture-typora-bucket.oss-cn-shanghai.aliyuncs.com/typora/go.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Go语言之strconv</div></div></a></div><div class="next-post pull-right"><a href="/2021/12/20/Go/Go%E8%AF%AD%E8%A8%80%E5%B8%B8%E7%94%A8%E6%A0%87%E5%87%86%E5%BA%93/08-Go%E8%AF%AD%E8%A8%80%E4%B9%8Bjson/"><img class="next-cover" src="https://picture-typora-bucket.oss-cn-shanghai.aliyuncs.com/typora/go.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Go语言之json</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2021/12/20/Go/Go%E8%AF%AD%E8%A8%80%E5%B8%B8%E7%94%A8%E6%A0%87%E5%87%86%E5%BA%93/06-Go%E8%AF%AD%E8%A8%80%E4%B9%8Bstrconv/" title="Go语言之strconv"><img class="cover" src="https://picture-typora-bucket.oss-cn-shanghai.aliyuncs.com/typora/go.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-12-20</div><div class="title">Go语言之strconv</div></div></a></div><div><a href="/2021/12/20/Go/Go%E8%AF%AD%E8%A8%80%E5%B8%B8%E7%94%A8%E6%A0%87%E5%87%86%E5%BA%93/08-Go%E8%AF%AD%E8%A8%80%E4%B9%8Bjson/" title="Go语言之json"><img class="cover" src="https://picture-typora-bucket.oss-cn-shanghai.aliyuncs.com/typora/go.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-12-20</div><div class="title">Go语言之json</div></div></a></div><div><a href="/2021/12/20/Go/Go%E8%AF%AD%E8%A8%80%E5%B8%B8%E7%94%A8%E6%A0%87%E5%87%86%E5%BA%93/%E2%80%8B02-Go%E8%AF%AD%E8%A8%80%E4%B9%8Bflag/" title="Go语言之flag"><img class="cover" src="https://picture-typora-bucket.oss-cn-shanghai.aliyuncs.com/typora/go.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-12-20</div><div class="title">Go语言之flag</div></div></a></div><div><a href="/2021/12/20/Go/Go%E8%AF%AD%E8%A8%80%E5%B8%B8%E7%94%A8%E6%A0%87%E5%87%86%E5%BA%93/%E2%80%8B05-Go%E8%AF%AD%E8%A8%80%E4%B9%8Bnet_http/" title="Go语言之net_http"><img class="cover" src="https://picture-typora-bucket.oss-cn-shanghai.aliyuncs.com/typora/go.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-12-20</div><div class="title">Go语言之net_http</div></div></a></div><div><a href="/2021/12/20/Go/Go%E8%AF%AD%E8%A8%80%E5%B8%B8%E7%94%A8%E6%A0%87%E5%87%86%E5%BA%93/%E2%80%8B03-Go%E8%AF%AD%E8%A8%80%E4%B9%8Bfmt/" title="Go语言之fmt"><img class="cover" src="https://picture-typora-bucket.oss-cn-shanghai.aliyuncs.com/typora/go.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-12-20</div><div class="title">Go语言之fmt</div></div></a></div><div><a href="/2021/12/20/Go/Go%E8%AF%AD%E8%A8%80%E5%B8%B8%E7%94%A8%E6%A0%87%E5%87%86%E5%BA%93/%E2%80%8B04-Go%E8%AF%AD%E8%A8%80%E4%B9%8Blog/" title="Go语言之log"><img class="cover" src="https://picture-typora-bucket.oss-cn-shanghai.aliyuncs.com/typora/go.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-12-20</div><div class="title">Go语言之log</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://picture-typora-bucket.oss-cn-shanghai.aliyuncs.com/typora/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"></div><div class="author-info__name">John Doe</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">380</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">38</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">44</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/zhzhang12138"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">This is my blog   <img src="https://cdn.jsdelivr.net/gh/CNhuazhu/Image/pig.gif"></div><timing></timing></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81Context"><span class="toc-number">1.</span> <span class="toc-text">为什么需要Context</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E7%A4%BA%E4%BE%8B"><span class="toc-number">2.</span> <span class="toc-text">基本示例</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F%E6%96%B9%E5%BC%8F"><span class="toc-number">3.</span> <span class="toc-text">全局变量方式</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%80%9A%E9%81%93%E6%96%B9%E5%BC%8F"><span class="toc-number">4.</span> <span class="toc-text">通道方式</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%98%E6%96%B9%E7%89%88%E7%9A%84%E6%96%B9%E6%A1%88"><span class="toc-number">5.</span> <span class="toc-text">官方版的方案</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Context%E5%88%9D%E8%AF%86"><span class="toc-number">6.</span> <span class="toc-text">Context初识</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Context%E6%8E%A5%E5%8F%A3"><span class="toc-number">7.</span> <span class="toc-text">Context接口</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/06/01/%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2/flask%E8%84%9A%E6%9C%AC%E9%83%A8%E7%BD%B2%E5%88%B0%E6%9C%8D%E5%8A%A1%E5%99%A8/" title="flask脚本部署到服务器"><img src="https://img2.baidu.com/it/u=2057739962,349198015&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG?w=500&amp;h=500" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="flask脚本部署到服务器"></a><div class="content"><a class="title" href="/2022/06/01/%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2/flask%E8%84%9A%E6%9C%AC%E9%83%A8%E7%BD%B2%E5%88%B0%E6%9C%8D%E5%8A%A1%E5%99%A8/" title="flask脚本部署到服务器">flask脚本部署到服务器</a><time datetime="2022-06-01T09:41:00.000Z" title="发表于 2022-06-01 17:41:00">2022-06-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/06/01/%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95/RSA%E5%8A%A0%E5%AF%86/" title="RSA加密"><img src="https://img2.baidu.com/it/u=1100699556,179239278&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG?w=1014&amp;h=500" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="RSA加密"></a><div class="content"><a class="title" href="/2022/06/01/%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95/RSA%E5%8A%A0%E5%AF%86/" title="RSA加密">RSA加密</a><time datetime="2022-06-01T09:34:00.000Z" title="发表于 2022-06-01 17:34:00">2022-06-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/06/01/%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95/Python%E5%AE%9E%E7%8E%B0%E5%B8%B8%E8%A7%81%E7%9A%84%E2%BC%8F%E7%A7%8D%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95/" title="Python实现常见的⼏种加密算法"><img src="https://img2.baidu.com/it/u=1100699556,179239278&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG?w=1014&amp;h=500" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Python实现常见的⼏种加密算法"></a><div class="content"><a class="title" href="/2022/06/01/%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95/Python%E5%AE%9E%E7%8E%B0%E5%B8%B8%E8%A7%81%E7%9A%84%E2%BC%8F%E7%A7%8D%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95/" title="Python实现常见的⼏种加密算法">Python实现常见的⼏种加密算法</a><time datetime="2022-06-01T09:33:00.000Z" title="发表于 2022-06-01 17:33:00">2022-06-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/06/01/%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95/%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86%E5%92%8C%E9%9D%9E%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86/" title="对称加密和非对称加密"><img src="https://img2.baidu.com/it/u=1100699556,179239278&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG?w=1014&amp;h=500" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="对称加密和非对称加密"></a><div class="content"><a class="title" href="/2022/06/01/%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95/%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86%E5%92%8C%E9%9D%9E%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86/" title="对称加密和非对称加密">对称加密和非对称加密</a><time datetime="2022-06-01T09:32:00.000Z" title="发表于 2022-06-01 17:32:00">2022-06-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/05/17/Python%E7%B3%BB%E5%88%97/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/1%E3%80%81Python%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E7%AE%80%E4%BB%8B/" title="Python并发编程简介"><img src="https://img0.baidu.com/it/u=118987628,2806352071&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG?w=500&amp;h=500" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Python并发编程简介"></a><div class="content"><a class="title" href="/2022/05/17/Python%E7%B3%BB%E5%88%97/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/1%E3%80%81Python%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E7%AE%80%E4%BB%8B/" title="Python并发编程简介">Python并发编程简介</a><time datetime="2022-05-17T10:33:00.000Z" title="发表于 2022-05-17 18:33:00">2022-05-17</time></div></div></div></div></div></div></main><footer id="footer" style="background: transparent"><div id="footer-wrap"><div class="copyright">©2020 - 2022 <i id="heartbeat" class="fa fas fa-heartbeat"></i>  John Doe</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to my <a href="">blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="translateLink" type="button" title="简繁转换">简</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="algolia-search"><div class="search-dialog"><div class="search-dialog__title" id="algolia-search-title">Algolia</div><div id="algolia-input-panel"><div id="algolia-search-input"></div></div><hr><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-stats"></div></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="/js/search/algolia.js"></script><div class="js-pjax"><script async="async">var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> {preloader.endLoading()})
setTimeout(function(){preloader.endLoading();}, 3000);</script></div><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '',
      appKey: '',
      placeholder: 'Please leave your footprints',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'zh-CN',
      recordIP: false,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: false,
      path: window.location.pathname,
      requiredFields: ["nick,mail"],
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script src="/js/timing.js"></script><script src="https://cdn.jsdelivr.net/gh/weilain/cdn-photo/js/jquery.min.js"></script><script async="" data-pjax="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script type="text/javascript" src="/js/crash_cheat.js"></script></body></html>